---
title: "SQL"
output: html_document
---

## Filtering Columns and Rows

With SQL, you can filter columns and rows by using SELECT and WHERE. Here's an example using the Lahman database. First, load the database, along with the package sqldf.

```{r message=FALSE, warning=FALSE}
library(Lahman)
library(sqldf)
```

If I wanted to see **total homeruns** for the 1927 Yankees, I could write the following query:

```{r}
query<-"SELECT playerID,yearID,teamID,HR FROM Batting
WHERE teamID='NYA' and yearID=1927"
sqldf(query)

```

We can also use greater than or less than symbols to narrow in our results. Lets look at a few examples. Say I wanted to find all instances where the Yankees hit **40 homeruns or more**:

```{r}
query<-"SELECT playerID,yearID,teamID,HR FROM Batting
WHERE teamID='NYA' and HR>=40"
sqldf(query)

```

To find all the instances in history where a player had **more than 40 homeruns**, but **less than 40 strikeouts**, I would enter the following query:

```{r}
query<-"SELECT playerID,yearID,teamID,HR,SO FROM Batting
WHERE HR>40 and SO<60"
sqldf(query)

```

Say I wanted to look at a **specific time period**. For example, I want to find all instances of the Phillies hitting more than 30 homeruns **in the 1970s**:

```{r}
query<-"SELECT playerID,yearID,teamID,HR FROM Batting
WHERE teamID='PHI' and yearID>=1970 and yearID<1980 and HR>30"
sqldf(query)

```

## ORDER BY 
#### Order the rows of your output

Let's look at how we can organize these stats in a specific order. I want to find every instance of a player hitting more than 50 homeruns, but I want to order them by having the player with **highest homerun total at the top**:

```{r}
query<-"SELECT playerID,teamID,yearID,HR FROM Batting
WHERE HR>50
ORDER BY HR DESC"

sqldf(query)

```

Find all instances of a player striking out less than 10 times. Make sure each player has had at least 400 at-bats (AB). Order by having least strikeouts at the top

```{r}
query<-"SELECT playerID,yearID,teamID,SO,AB FROM Batting
WHERE SO<10 and AB>=400
ORDER BY SO"

sqldf(query)

```

### Aggregation

We want to find all Babe Ruth's total homeruns 

```{r}
query<-"SELECT playerID,sum(HR) FROM Batting
WHERE playerID='ruthba01'
GROUP BY playerID"

sqldf(query)

```

Find all career homerun totals for all players, but limit the output to totals 600 or more. Order by career total.

```{r}
query<-"SELECT playerID,sum(HR) FROM Batting
GROUP BY playerID
HAVING sum(HR)>=600
ORDER BY sum(HR) DESC"

sqldf(query)

```

Find the players who have averaged more than 30 homeruns per year throughout their career. Order them by having the highest average at the top.

```{r}
query<-"SELECT playerID,avg(HR) FROM Batting
GROUP BY playerID
HAVING avg(HR)>30
ORDER BY avg(HR) DESC"

sqldf(query)

```

### Joins

First and Last names, along with team, year, and homeruns. Player should be Babe Ruth. Find all instances of players hitting more than 50 homeruns. Include first and last names, team, year, and homeruns. It is important to eliminate ambiguity. Since we are using information from two tables (Batting and Master), we need to indicate where we want to draw the information from. For example, instead of writing WHERE playerID='ruthba01', we will need to indicate that we want to draw it from Batting.

```{r}
query<-"SELECT nameFIRST, nameLAST,teamID,yearID,HR 
FROM Batting INNER JOIN Master
ON Batting.playerID=Master.playerID
WHERE Batting.playerID='ruthba01'"

sqldf(query)

```

Find all instances of players hitting more than 50 homeruns. Include first and last names, team, year, and homeruns.

```{r}
query<-"SELECT nameFIRST, nameLAST,teamID,yearID,HR 
FROM Batting INNER JOIN Master
ON Batting.playerID=Master.playerID
WHERE HR>50"

sqldf(query)

```

Babe Ruth homeruns by season, with playerID, team name, year, and homeruns. The Teams table has some overlapping information with Batting. Both the Batting table and the Teams table have an yearID and HR column. Therefore, we need to indicate where we want to pull the information from. When we use "ON", we need to indicate what information is the same in both tables and eliminate a duplicate from both tables. This is why we write "ON Batting.teamID=Teams.teamID" etc. This will make sure not to duplicate the information from both the Batting table and the Teams table.

```{r}
query<-"SELECT playerID,name,Batting.yearID,Batting.HR 
FROM Batting INNER JOIN Teams
ON Batting.teamID=Teams.teamID AND Batting.yearID=Teams.yearID
WHERE playerID='ruthba01'"

sqldf(query)

```

